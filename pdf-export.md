# Экспорт PDF: текущий статус и план работ

## Архитектура решения

- **Библиотека:** переходим на iText 7 (модули `kernel`, `layout`, `svg`, `io`).
- **Сервис экспорта:** `ExportService` отвечает за обработку входных данных (SVG, PNG, готовые PDF), создание iText-документов, объединение страниц и применение ICC-профилей.
- **Ресурсы iText:** `ITextPdfResourceFactory` загружает шрифты из `resources/fonts`, назначает fallback-гарнитуру, добавляет ICC-профили (`applyOutputIntent`) и настраивает `WriterProperties`.
- **SVG-конвертер:** `SvgRenderer` использует `SvgConverter.convertToXObject` из iText, масштабирует и добавляет полученный `PdfFormXObject` на страницу.
- **Анализ PDF:** `PdfAnalysisService` (на базе iText) проверяет встроенные шрифты, цветовые пространства изображений (CMYK/RGB), наличие прозрачностей; используется в интеграционных тестах для регрессии.
- **JPEG/CMYK:** `ImageProcessingService` + `JpegWriter` конвертируют растры в CMYK и сохраняют через `ImageDataFactory` в PDF.

## Что уже сделано

- Перевели сервисы экспорта на iText 7, убрав зависимости от PDFBox.
- Реализовали загрузку шрифтов в `FontProvider`, фильтрацию problem-шрифтов и fallback на безопасную гарнитуру.
- Обновили `SvgRenderer` под API iText, добавили обработку размеров и предупреждение для outline-режима.
- Расширили `PdfAnalysisService`: рекурсивно собираем шрифты из форм XObject, корректно определяем цветовые пространства (включая ICC-профили) и прозрачность.
- Интеграционные тесты (`ExportControllerIntegrationTest`) перевели на новый анализатор: проверяем наличие векторных шрифтов и CMYK-изображений, валидируем outline-режим.
- Конвертация PNG→PDF сохраняет CMYK через `ImageProcessingService` и `JpegWriter`.

## Оставшиеся задачи

1. **Устранить падение SVG-экспорта из-за нестандартных шрифтов** (например, `LainyDay`). Нужна либо жёсткая фильтрация, либо явный fallback при конвертации SVG, чтобы iText не выбрасывал `UnsupportedCharsetException`.
2. **Режим outline**: сейчас выводим предупреждение; требуется реализовать конвертацию текста в кривые (или документировать ограничение) и обновить тест `svgExportWithOutlineTextModeConvertsTextToPaths`.
3. **Пользовательские шрифты:** обеспечить загрузку/встраивание гарнитур, передаваемых пользователем (UI уже поддерживает выбор режима `svgTextMode`).
4. **Финальная регрессия:** после фиксов повторно прогнать `ExportControllerIntegrationTest` и смежные тесты, подтвердить корректность CMYK/шрифтов.

## Следующие шаги

- Доработать фильтрацию шрифтов в `ITextPdfResourceFactory` или внедрить fallback на этапе `SvgRenderer`, чтобы SvgConverter всегда использовал поддерживаемую гарнитуру.
- Вернуть или отложить режим outline: реализовать конвертацию текста в PATH либо задокументировать временное ограничение.
- Реализовать поддержку пользовательских шрифтов (загрузка, кеширование, очистка).
- Провести полноценную регрессию после изменений.
