# Java Export Server

Spring Boot сервис, выполняющий конвертацию файлов из Figma (SVG/PNG/PDF) в типографские форматы PDF и TIFF с поддержкой CMYK. Версия сейчас упрощена: все настройки фиксированы, дополнительных опций нет.

## Требования

- Java 17+
- Maven Wrapper (скачивается автоматически при первом запуске)

## Запуск

```powershell
# из директории server-java
./mvnw.cmd spring-boot:run
```

Для Unix-подобных систем используется `./mvnw spring-boot:run`.

Приложение доступно по адресу `http://localhost:8080`. Основной REST-эндпоинт — `/convert` (метод POST, `multipart/form-data`).

## Поддерживаемые возможности

- **PDF экспорт**
  - Векторный рендеринг SVG при помощи Apache Batik + PdfBoxGraphics2D с fallback в растр, если необходимо.
  - Всегда используется ICC-профиль Coated FOGRA39 и версия PDF 1.4.
  - **Новое**: Поддержка множественных элементов в одном PDF
    - Векторные элементы (SVG) сохраняются как редактируемые векторные объекты
    - Растровые элементы (PNG) конвертируются в CMYK
    - Итоговый PDF можно редактировать в Adobe Illustrator или CorelDRAW

- **TIFF экспорт**
  - Любой входящий SVG/PNG/PDF переводится в CMYK с тем же профилем.
  - Поддержка параметров качества: standard, supersample, texthint.
  - Опциональное LZW-сжатие.
  - Настраиваемое разрешение (PPI).

- **Figma плагин**
  - UI (`ui.html`) позволяет выбрать формат (`pdf` или `tiff`) и настроить параметры экспорта.
  - Скрипт (`code.js`) автоматически определяет тип элементов (векторные/растровые) и экспортирует их соответствующим образом.
  - Для PDF с несколькими элементами создаётся один объединённый файл.

## API `/convert`

### Одиночный файл

| Поле              | Тип     | Описание |
|-------------------|---------|----------|
| `image`           | файл    | Исходный SVG/PNG/PDF из Figma |
| `format`          | строка  | `pdf` или `tiff` |
| `name`            | строка  | Имя файла без расширения |
| `ppi`             | число   | Разрешение (PPI) |
| `pdfVersion`      | строка  | Всегда `1.4` (оставлено для совместимости) |
| `pdfStandard`     | строка  | Всегда `none` |
| `pdfColorProfile` | строка  | Всегда `coated_fogra39` |
| `tiffLzw`         | boolean | Использовать LZW-сжатие для TIFF |
| `tiffQuality`     | строка  | Качество TIFF: `standard`, `supersample`, `texthint` |
| `widthPx` / `heightPx` | число | Необязательное переопределение размера (px) |

### Множественные файлы (только PDF)

| Поле              | Тип     | Описание |
|-------------------|---------|----------|
| `images`          | файлы   | Массив SVG/PNG файлов для объединения |
| `format`          | строка  | `pdf` |
| `name`            | строка  | Имя файла без расширения |
| `ppi`             | число   | Разрешение (PPI) |
| `widthPx_N` / `heightPx_N` | число | Размеры N-го элемента (px) |

В ответ сервер возвращает бинарный PDF/TIFF с корректно выставленными заголовками.

## Тесты

```
./mvnw.cmd clean test
```

Интеграционные тесты проверяют успешную конвертацию SVG→PDF и корректную обработку невалидных запросов.

## Основные модули

- `ExportController` — REST API.
- `ExportService` — бизнес-логика экспорта.
- `ColorProfileManager` — загрузка ICC-профилей.
- `ImageProcessingService` — масштабирование, конвертация в CMYK, запись TIFF/JPEG.
- `SvgRenderer` — векторный рендеринг SVG через Batik.

## Настройки деплоя

- **CORS** — включён фильтр, разрешающий запросы из `https://*.figma.com` и из локального плагина (источник `null`). Дополнительных настроек со стороны Railway не требуется.
- **Размеры файлов** — по умолчанию разрешены загрузки до 200 МБ (`spring.servlet.multipart.max-file-size` и `spring.servlet.multipart.max-request-size`). При необходимости значения можно скорректировать в `application.properties`.
- **Ограничение памяти** — при деплое на Railway рекомендовано задать переменную окружения `JAVA_TOOL_OPTIONS=-Xms256m -Xmx768m`, чтобы избежать `OutOfMemoryError` при обработке крупных файлов.

