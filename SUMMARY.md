# Итоги миграции на Java-сервер

## 1. Краткий обзор проделанной работы
- Создано Spring Boot-приложение (`server-java`) для обработки экспорта PDF/TIFF вместо прежнего Node.js сервера.
- Настроен Maven Wrapper с зависимостями Apache PDFBox 3.x (pdfbox, fontbox, xmpbox, preflight), Batik 1.17 и TwelveMonkeys ImageIO; подключён набор ICC-профилей (Coated FOGRA39, ISO Coated v2, US Web Coated (SWOP)).
- Реализованы DTO, сервисы и глобальный обработчик исключений с локализованными сообщениями, добавлены модульные и интеграционные тесты.
- В сервер интегрированы конвейеры SVG→PDF, PDF→CMYK и TIFF с учётом DPI, сжатия и параметров TIFF; для PDF поддерживаются профили и стандарты PDF/X (векторный рендеринг + fallback).
- Настроены Dockerfile (двухстадийная сборка JDK→JRE) и Maven-wrapper build, что позволило проводить деплой на Railway.
- Добавлен CORS-фильтр, разрешающий обращения из Figma (включая origin `null`).
- Реализована обработка ошибок Batik: при сбоях рендеринга выполняется fallback в растеризацию без падения сервиса.
- Выполнена чистка репозитория: удалён Node.js сервер, обновлены настройки плагина и документация.

## 2. Текущий функционал
### Java-сервер
- REST-эндпоинт `/convert` принимает multipart/form-data с файлами SVG/PNG/PDF и параметрами экспорта.
- PDF экспорт:
  - Векторный рендеринг SVG (Apache Batik + PdfBoxGraphics2D) с проекцией цветов в CMYK.
  - Автоматический fallback в растровый режим при проблемах в SVG / изображениях.
  - Поддержка стандартов PDF/X (1a/3/4): формирование XMP-метаданных, настройка OutputIntent и обязательная Preflight-проверка с отчётом об ошибках.
- TIFF экспорт:
  - Конвертация в CMYK с выбранным ICC-профилем, масштабирование и антиалиасинг (`none`/`fast`/`balanced`/`best`).
  - Выбор сжатия (без сжатия, LZW) и DPI.
- `ColorProfileManager` загружает несколько ICC-профилей и предоставляет их сервисам.
- `ImageProcessingService` реализует масштабирование, антиалиас, CMYK-конвертацию, запись TIFF/JPEG с DPI-метаданными.
- `SvgRenderer` отвечает за векторную отрисовку SVG и генерацию PDF страниц.
- Глобальный обработчик исключений возвращает локализованные ответы и корректные HTTP-коды.
- Настройки через `application.properties`: headless, лимиты multipart, порт.

### Figma-плагин
- UI (`ui.html`) предоставляет настройки экспорта: формат, стандарт/версию PDF, ICC-профиль, DPI, параметры TIFF.
- Скрипт (`code.js`) собирает выделенные в Figma узлы, экспортирует их в SVG/PNG, добавляет размеры и отправляет запрос на сервер.
- Конфигурация URL: production (`https://figmapluginillustrator.up.railway.app`) и dev (`http://localhost:8080`).
- Обработка ошибок отображает сообщение из ответа сервера.

## 3. Инфраструктура и деплой
- Dockerfile в корне репозитория:
  - Stage `builder`: Maven Wrapper скачивает зависимости и собирает `export-server-*.jar`.
  - Stage `runtime`: образ Eclipse Temurin JRE 17, запуск Spring Boot с учётом переменной `PORT`.
- Railway использует Dockerfile из корня: автосборка и деплой приложения (доступ через `https://figmapluginillustrator.up.railway.app`).
- `manifest.json` плагина обновлён под новый URL и dev-порт.

## 4. Тестирование и текущий статус
- Локально доступны `./mvnw.cmd clean test` и `./mvnw.cmd spring-boot:run`.
- Тесты:
  - `ImageProcessingServiceTest` — проверяет конвертацию в CMYK и сохранение TIFF/JPEG.
  - `ExportControllerIntegrationTest` — проверяет SVG→PDF с разными ICC-профилями и обработку некорректных параметров.
- Figma-плагин соединяется с Railway-развёртыванием; CORS разрешает origin `null`.

## 5. План дальнейших работ


## 6. Ключевые изменения в репозитории
- **`server/` удалён**, весь функционал перенесён на Java.
- **`Dockerfile` (корень)** — новый сценарий сборки и запуска.
- **`server-java/src/main/java/com/figma/export/config/CorsConfig.java`** — конфигурация CORS.
- **`ExportService`** — переработан для fallback SVG и корректного управления сохранением векторов.
- **`manifest.json`** — обновлён список доменов и dev-порт.

## 7. Текущее состояние
- Репозиторий на ветке `main` содержит все последние правки.
- Сервер задеплоен на Railway и готов к e2e тестированию.
- Плагин обращается к новому Java API; готовы инструкции для локального и удалённого теста.
