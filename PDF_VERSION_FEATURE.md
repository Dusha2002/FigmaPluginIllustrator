# Выбор версии PDF (1.3 - 1.7)

## Описание

Добавлена возможность выбора версии PDF при экспорте. Поддерживаются версии от 1.3 до 1.7.

## Что изменено

### UI (ui.html)

**Добавлен выпадающий список версий PDF:**
```html
<select id="pdf-version" aria-label="Версия PDF">
  <option value="1.3">PDF 1.3 (Acrobat 4)</option>
  <option value="1.4" selected>PDF 1.4 (Acrobat 5)</option>
  <option value="1.5">PDF 1.5 (Acrobat 6)</option>
  <option value="1.6">PDF 1.6 (Acrobat 7)</option>
  <option value="1.7">PDF 1.7 (Acrobat 8+)</option>
</select>
```

**Функциональность:**
- Выпадающий список показывается только для формата PDF
- При переключении на TIFF опции PDF скрываются
- Значение по умолчанию: **1.4** (наиболее совместимая версия)
- Выбранная версия сохраняется в настройках плагина

### Клиентская часть (code.js)

**Передача версии PDF:**
```javascript
const pdfVersion = settings && typeof settings.pdfVersion === 'string' 
  ? settings.pdfVersion 
  : '1.4';

return {
  // ...
  pdfVersion: exportFormat === 'pdf' ? pdfVersion : '1.4'
};
```

### Серверная часть (Java)

#### ExportRequest.java
**Добавлено поле с валидацией:**
```java
@Pattern(regexp = "1\\.[3-7]", message = "pdfVersion должен быть от 1.3 до 1.7")
private String pdfVersion;

public String getPdfVersion() {
    return pdfVersion;
}

public void setPdfVersion(String pdfVersion) {
    this.pdfVersion = pdfVersion;
}
```

#### ExportService.java
**Метод парсинга версии:**
```java
private float parsePdfVersion(String pdfVersion) {
    if (pdfVersion == null || pdfVersion.isEmpty()) {
        return 1.4f;
    }
    try {
        float version = Float.parseFloat(pdfVersion);
        if (version >= 1.3f && version <= 1.7f) {
            return version;
        }
        logger.warn("Некорректная версия PDF: {}. Используется 1.4", pdfVersion);
        return 1.4f;
    } catch (NumberFormatException e) {
        logger.warn("Не удалось распарсить версию PDF: {}. Используется 1.4", pdfVersion);
        return 1.4f;
    }
}
```

**Применение версии:**
```java
private void applyPdfDefaults(PDDocument document, ColorProfile profile, String pdfVersion) {
    float version = parsePdfVersion(pdfVersion);
    document.setVersion(version);
    logger.info("Установлена версия PDF: {}", version);
    // ...
}
```

## Версии PDF и их особенности

### PDF 1.3 (Acrobat 4, 1999)
- **Совместимость:** Максимальная, работает везде
- **Ограничения:** Нет прозрачности, нет слоёв
- **Использование:** Для максимальной совместимости со старыми системами

### PDF 1.4 (Acrobat 5, 2001) ⭐ По умолчанию
- **Совместимость:** Отличная
- **Возможности:** Прозрачность, CMYK, ICC-профили
- **Использование:** Рекомендуется для типографской печати
- **Стандарт:** PDF/X-1a:2001 основан на PDF 1.4

### PDF 1.5 (Acrobat 6, 2003)
- **Совместимость:** Хорошая
- **Возможности:** Сжатие объектов, слои (Optional Content)
- **Использование:** Для сложных документов с интерактивными элементами

### PDF 1.6 (Acrobat 7, 2004)
- **Совместимость:** Хорошая
- **Возможности:** 3D-контент, расширенная безопасность
- **Использование:** Для документов с 3D-моделями

### PDF 1.7 (Acrobat 8+, 2006)
- **Совместимость:** Современные системы
- **Возможности:** Все современные функции PDF
- **Использование:** Для современных workflow
- **Стандарт:** ISO 32000-1:2008

## Рекомендации по выбору версии

### Для типографской печати
**Используйте PDF 1.4** ✅
- Максимальная совместимость с RIP-системами
- Поддержка всех необходимых функций (CMYK, ICC-профили)
- Стандарт PDF/X-1a основан на PDF 1.4

### Для цифровой печати
**Используйте PDF 1.4 или 1.5** ✅
- PDF 1.5 позволяет лучшее сжатие
- Поддержка слоёв может быть полезна

### Для архивирования
**Используйте PDF 1.4** ✅
- Максимальная долговечность
- Гарантированная читаемость в будущем

### Для современных workflow
**Используйте PDF 1.7** ✅
- Все современные возможности
- Лучшая поддержка метаданных

## Проверка версии PDF

### В Adobe Acrobat:
1. File → Properties (Ctrl+D)
2. Вкладка "Description"
3. Поле "PDF Version"

### В командной строке (pdfinfo):
```bash
pdfinfo document.pdf | grep "PDF version"
```

### В логах сервера:
```
INFO: Установлена версия PDF: 1.4
```

## Совместимость с CMYK

Все версии от 1.3 до 1.7 поддерживают:
- ✅ CMYK цветовое пространство
- ✅ ICC-профили (Coated FOGRA39)
- ✅ Векторную графику
- ✅ OutputIntent для типографии

## Примеры использования

### Экспорт для типографии (PDF/X-1a)
```
Версия: PDF 1.4
Цветовое пространство: CMYK
ICC-профиль: Coated FOGRA39
Векторная графика: Да
```

### Экспорт для веб-просмотра
```
Версия: PDF 1.7
Цветовое пространство: CMYK (для печати) или RGB (для экрана)
Сжатие: Максимальное
```

### Экспорт для архива
```
Версия: PDF 1.4
Цветовое пространство: CMYK
Сжатие: Без потерь
Метаданные: Полные
```

## Логирование

При экспорте в логах сервера вы увидите:
```
INFO: Конвертация в PDF: baseName=Rectangle, uploadType=SVG, dpi=72
INFO: Установлена версия PDF: 1.4
INFO: Документ ВЕКТОРНЫЙ - сохраняется как есть с CMYK color mapping
```

Если версия некорректна:
```
WARN: Некорректная версия PDF: 2.0. Используется 1.4
```

## Безопасность

**Валидация на клиенте:**
- Выпадающий список ограничивает выбор версий 1.3-1.7

**Валидация на сервере:**
- Regex pattern: `1\.[3-7]`
- Парсинг с проверкой диапазона
- Fallback на 1.4 при ошибке

## Тестирование

1. Выберите версию PDF в UI
2. Экспортируйте документ
3. Проверьте версию в Adobe Acrobat (File → Properties)
4. Проверьте логи сервера на наличие "Установлена версия PDF: X.X"

## Известные ограничения

- Версии ниже 1.3 не поддерживаются (устарели)
- Версии выше 1.7 не поддерживаются (PDF 2.0 требует отдельной реализации)
- Выбор версии не влияет на содержимое PDF (векторность, CMYK)
- Версия влияет только на формат файла и доступные функции

## Техническая проблема и решение

### Проблема: PDFBox автоматически повышает версию

Apache PDFBox может автоматически повышать версию PDF при сохранении, если документ содержит функции, требующие более высокой версии:

- **Прозрачность** → автоматически повышает до PDF 1.4
- **Расширенные графические состояния** → могут повышать до PDF 1.6
- **Определённые операции с цветом** → могут повышать версию

### Решение: Принудительная установка версии

Версия PDF устанавливается **дважды**:

1. **В `applyPdfDefaults()`** - первоначальная установка
2. **Перед `document.save()`** - финальная принудительная установка

```java
// Применяем настройки
applyPdfDefaults(workingDocument, colorProfile, pdfVersion);

// Принудительно устанавливаем версию ещё раз перед сохранением
float finalVersion = parsePdfVersion(pdfVersion);
workingDocument.setVersion(finalVersion);
logger.info("Финальная версия PDF перед сохранением: {}", finalVersion);

// Сохраняем
byte[] pdfBytes = saveDocument(workingDocument);
```

Это гарантирует, что выбранная пользователем версия будет применена, даже если PDFBox пытается её изменить.
