# Минимальный рефакторинг Figmastrator

## Базовые договорённости

- **UI**: визуально оставляем нынешнее окно плагина. Все элементы интерфейса сохраняем, но временно делаем неактивными те контролы, за которыми ещё не стоит функционал.
- **Конвертация единиц**: Figma оперирует `72 dpi`, поэтому используем фиксированные формулы
  - `PX_PER_MM = 72 / 25.4`
  - `MM_PER_PX = 25.4 / 72`
  Обновить расчёты в `code.js` и `ui.html`, чтобы отображение миллиметров было корректным.
- **Экспорт TIFF**: минимально необходимый функционал — растрировать в CMYK с сохранением размеров (px и пересчёт мм), выставлять `XResolution = YResolution = 72`, `ResolutionUnit = INCH`, без дополнительных опций (антиалиас, сжатие, flatten и т.д.).
- **Экспорт PDF**: сохраняем исходную векторную структуру (все слои/фрейм как есть), но итоговый файл должен быть в цветовой модели CMYK.
- **Минимализм кода**: удаляем или комментируем все незадействованные опции, перечисления, конвертеры и тесты; оставляем только тот код, который нужен для работы UI, загрузки, растеризации и экспорта TIFF/PDF в упрощённом варианте.

## План рефакторинга

### Этап 0. Подготовка
1. Зафиксировать формулы 72 dpi в клиентском коде (`code.js`, `ui.html`).
2. Отключить (disabled) UI-элементы расширенных настроек, добавить TODO для будущего восстановления.

### Этап 1. Очистка сервера
1. Удалить/закомментировать из `ExportRequest`, сервисов и контроллера все параметры, связанные с:
   - альтернативными вариантами PPI;
   - сжатием/антиалиасом/flatten;
   - дополнительными конвертерами Spring для строковых значений;
   - расширенными тестами, завязанными на удаляемые функции.
2. Сфокусировать `ImageProcessingService` и смежные классы на минимальном наборе операций: чтение, базовая подготовка, CMYK-конвертация.
3. Обновить/удалить тесты так, чтобы сборка без лишних сценариев проходила (`./mvnw.cmd clean test`).

### Этап 2. Минимальный экспорт
1. **TIFF**
   - Преобразовывать входные данные (SVG/PNG/PDF) в растровое изображение нужного размера.
   - Конвертировать в CMYK и записывать TIFF с базовыми метаданными (72 dpi, INCH).
   - Написать простой тест, проверяющий успешность экспорта и присутствие CMYK.
2. **PDF**
   - Собрать PDF из исходного векторного содержимого без растрирования.
   - Обеспечить CMYK-профиль для финального файла.
   - Проверить, что интеграционный тест `/convert` для PDF возвращает валидный документ.
3. Согласовать новые контракты (формат запросов, ожидаемые поля) между клиентом и сервером и документировать в README/комментариях.

## Критерии готовности
- Формулы с 72 dpi используются в клиенте, UI работает и отображает корректные миллиметры.
- Лишний код удалён/отключён, проект собирается и тесты (минимальный набор) проходят.
- TIFF и PDF экспорт корректно возвращают файлы с нужными размерами и CMYK.
- Документация (`MINIMAL_REFACTOR_PLAN.md` + при необходимости README) отражает текущее состояние.

## Следующие шаги после минимального релиза
- Постепенное возвращение расширенных настроек (антиалиас, сжатие, flatten) с отдельными тестами.
- Улучшение UX: сохранение пользовательских параметров, подсказки по dpi/PPI.
- Расширение тестового покрытия и автоматизация проверки метаданных.
