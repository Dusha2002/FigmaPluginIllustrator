# Figma CMYK Export Plugin

## Обзор
Этот проект сочетает плагин для Figma и серверную часть на Spring Boot. Сервер выполняет конвертацию экспортированных из Figma ресурсов в CMYK/TIFF/PDF, сохраняя векторные элементы и корректно применяя цветовые профили печати.

## Основные возможности
- Конвертация выделенных элементов Figma в CMYK PDF или TIFF через удалённый сервер.
- Поддержка смешанного контента: векторные узлы экспортируются как SVG и остаются редактируемыми, растровые — как PNG с конвертацией в CMYK.
- Применение профиля Coated FOGRA39 (ICC) ко всем PDF и TIFF.
- Выбор стандарта PDF/X (PDF/X-1a:2001, PDF/X-3:2002, PDF/X-4) и автоматическое применение требуемых метаданных и ограничений.
- Fallback на OpenPDF, принудительно устанавливающий версию PDF, даже если Apache PDFBox повышает её из-за прозрачности или других особенностей.

## Клиентский UI
В интерфейсе плагина добавлены:
- Выпадающий список "Версия PDF" (1.3–1.7).
- Новый список "Стандарт PDF/X" с подсказками по требованиям каждого стандарта.
- Автоматическое повышение версии PDF, если выбранный стандарт требует более высокую (например, PDF/X-4 → 1.6).
- Сохранение пользовательских предпочтений (версия, стандарт, TIFF-настройки) в `clientStorage`.

## PDF/X стандарты
| Стандарт | Минимальная версия PDF | Требования |
|----------|-----------------------|------------|
| PDF/X-1a:2001 | 1.3 | Только CMYK, запрет прозрачности и нестандартных режимов наложения, вывод помечен как Trapped. |
| PDF/X-3:2002 | 1.3 | Допускает управляемый цвет, но также запрещает прозрачность. |
| PDF/X-4 | 1.6 | Поддерживает прозрачность; требует OutputIntent и метаданные PDF/X-4. |

Серверная логика (`ExportService`) добавляет метаданные `GTS_PDFXVersion`, `GTS_PDFXConformance`, помечает документ как `Trapped`, устанавливает `MarkInfo.marked = true` и добавляет OutputIntent с профилем Coated FOGRA39. Для PDF/X-1a и PDF/X-3 выполняется проверка прозрачности и режимов наложения; при нарушении возвращается ошибка `400`.

## Fallback OpenPDF
Apache PDFBox может повышать версию PDF до 1.6 в присутствии прозрачности или других особенностей. Чтобы гарантировать точное совпадение с запрошенной версией, реализован сервис `OpenPdfFallbackService`, который:
1. Читает готовый PDF.
2. Пересобирает его через OpenPDF `PdfCopy` с указанием нужной версии.
3. Возвращает документ с корректным заголовком `%PDF-X.Y`.

Интеграционные тесты проверяют повторную запись версий 1.3–1.7.

## Тестирование
Для запуска тестов серверной части:
```powershell
cd server-java
..\mvnw.cmd test
```

Параметризованные тесты в `ExportControllerIntegrationTest` проверяют:
- Совпадение заголовка PDF с выбранной версией.
- Установку PDF/X-метаданных.
- Отказ при нарушении требований PDF/X-1a (прозрачность).

## Известные ограничения
- PDF/X-1a и PDF/X-3 требуют полностью непрозрачных объектов; пользователю следует убирать прозрачность до экспорта.
- PDF/X поддерживается только при экспорте через сервер; локальный экспорт без сервера не поддерживает метаданные.
- Fallback OpenPDF не изменяет содержимое документа: если версия повышена из-за несовместимой функции, PDF может быть пересохранён в нужную версию, но совместимость редакторов следует проверять отдельно.
